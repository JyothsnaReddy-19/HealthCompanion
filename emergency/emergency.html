<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hospital Search in Hyderabad</title>
  <style>
    /* Styling for the map container */
    #map {
      height: 500px;
      width: 100%;
    }

    /* Styling for search input */
    #search {
      margin-bottom: 20px;
      padding: 10px;
      width: 300px;
    }

    /* Styling hospital list container */
    .hospital-details {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
    }

    .hospital-list {
      margin-top: 20px;
    }

    .hospital-item {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #fff;
    }
  </style>
</head>
<body>
  <h1>Hospital Search in Hyderabad</h1>
  <input type="text" id="search" placeholder="Search for a hospital..." />
  <div id="map"></div>
  <div id="hospital-list" class="hospital-list"></div>

  <script>
    let hospitalsData = []; // To store hospital data fetched from the Overpass API
    let map; // Reference to the Leaflet map
    let markers = []; // To store map markers

    // Fetch hospital data using the Overpass API
    async function fetchHospitals() {
      const overpassUrl = "https://overpass-api.de/api/interpreter";
      const query = `
        [out:json][timeout:25];
        area["name"="Hyderabad"]->.hyderabad;
        (
          node["amenity"="hospital"](area.hyderabad);
          way["amenity"="hospital"](area.hyderabad);
          relation["amenity"="hospital"](area.hyderabad);
        );
        out body;
        >;
        out skel qt;
      `;

      try {
        const response = await fetch(overpassUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `data=${encodeURIComponent(query)}`,
        });

        const data = await response.json();
        hospitalsData = data.elements; // Store fetched hospital data
      } catch (error) {
        console.error("Error fetching data from Overpass API:", error);
      }
    }

    // Initialize the Leaflet map
    function initializeMap() {
      map = L.map("map").setView([17.3850, 78.4867], 12); // Center map on Hyderabad
      
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
      }).addTo(map);
    }

    // Handle hospital search based on input
    function handleSearch() {
      const searchTerm = document.getElementById("search").value.toLowerCase();
      const matchingHospitals = hospitalsData.filter((hospital) => {
        const name = hospital.tags?.name?.toLowerCase() || "";
        return name.includes(searchTerm);
      });

      if (matchingHospitals.length > 0) {
        showHospitalsOnMap(matchingHospitals);
        showHospitalList(matchingHospitals);
      } else {
        alert("No hospitals found. Please try another name.");
      }
    }

    // Display hospitals on the map
    function showHospitalsOnMap(hospitals) {
      // Remove previous markers
      markers.forEach((marker) => marker.remove());
      markers = [];

      hospitals.forEach((hospital) => {
        if (hospital.lat && hospital.lon) {
          const marker = L.marker([hospital.lat, hospital.lon])
            .addTo(map)
            .bindPopup(
              `<strong>${hospital.tags?.name || "Unnamed Hospital"}</strong><br>
              ${hospital.tags?.["addr:full"] || "Address not available"}<br>
              ${hospital.tags?.["contact:phone"] || hospital.tags?.["phone"] || hospital.tags?.["contact:mobile"] ? "Phone: " + formatPhoneNumber(hospital.tags?.["contact:phone"] || hospital.tags?.["phone"] || hospital.tags?.["contact:mobile"]) : ""}`
            );

          markers.push(marker);
        }
      });

      // Adjust the map view to fit all markers
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds());
      }
    }

    // Format phone numbers and handle 8-digit numbers
    function formatPhoneNumber(phone) {
      if (!phone) return "Phone number not available";
      if (/^\d{8}$/.test(phone)) return `${phone} (Add 040)`;
      return phone;
    }

    // Display hospital details in a list
    function showHospitalList(hospitals) {
      const hospitalListDiv = document.getElementById("hospital-list");
      hospitalListDiv.innerHTML = "<h2>Matching Hospitals</h2>";

      hospitals.forEach((hospital) => {
        const name = hospital.tags?.name || "Unnamed Hospital";
        const address = hospital.tags?.["addr:full"] || hospital.tags?.["addr:street"] || "";
        const city = hospital.tags?.["addr:city"] || "";
        const postcode = hospital.tags?.["addr:postcode"] || "";
        const phone = hospital.tags?.["contact:phone"] || hospital.tags?.["phone"] || hospital.tags?.["contact:mobile"];

        // Skip hospitals with no address at all
        if (!address && !city && !postcode) {
          return;
        }

        const fullAddress = [address, city, postcode].filter(Boolean).join(", ");

        const hospitalItem = document.createElement("div");
        hospitalItem.className = "hospital-item";
        hospitalItem.innerHTML = `
          <p><strong>Name:</strong> ${name}</p>
          <p><strong>Address:</strong> ${fullAddress}</p>
          ${phone ? `<p><strong>Phone:</strong> ${formatPhoneNumber(phone)}</p>` : ""}
        `;

        hospitalListDiv.appendChild(hospitalItem);
      });
    }

    // Initialize the map and fetch hospitals when the page loads
    document.addEventListener("DOMContentLoaded", () => {
      initializeMap();
      fetchHospitals();
      document.getElementById("search").addEventListener("input", handleSearch);
    });
  </script>

  <!-- Include Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
